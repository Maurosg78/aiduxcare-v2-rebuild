#!/usr/bin/env node

/**
 * EVALUACI√ìN CASO CL√çNICO COMPLEJO - FISIOTERAPIA
 * 
 * Prueba la capacidad de AiDuxCare de manejar un caso cl√≠nico complejo
 * con m√∫ltiples banderas rojas y generar un pipeline completo de an√°lisis.
 */

const winston = require('winston');

// Configurar logging
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [new winston.transports.Console()]
});

/**
 * CASO CL√çNICO COMPLEJO: TRAUMA CERVICAL CON COMPLICACIONES NEUROL√ìGICAS
 * 
 * Este caso est√° dise√±ado para activar m√∫ltiples banderas rojas y requerir
 * escalado a gemini-2.5-pro seg√∫n la estrategia 90/10.
 */
const casoClinicoComplejo = `
TRANSCRIPCI√ìN CONSULTA FISIOTERAPIA - CASO COMPLEJO

FISIOTERAPEUTA: Buenos d√≠as, ¬øc√≥mo se encuentra hoy?

PACIENTE: Doctora, vengo muy preocupada... hace 4 d√≠as tuve un accidente de auto, me golpe√© fuerte la cabeza y el cuello. Al principio pens√© que era solo un golpe, pero desde ayer estoy muy mal.

FISIOTERAPEUTA: Cu√©nteme exactamente qu√© s√≠ntomas tiene ahora.

PACIENTE: Tengo un dolor de cabeza terrible que no se me quita con nada, ni con ibuprofeno fuerte. Es como un dolor pulsante muy intenso, sobre todo aqu√≠ en la nuca. Y lo m√°s raro es que desde esta ma√±ana tengo como hormigueos en el brazo derecho y me siento d√©bil para agarrar cosas.

FISIOTERAPEUTA: ¬øHa tenido mareos o n√°useas?

PACIENTE: S√≠, mucho mareo, sobre todo cuando me levanto r√°pido. Y esta ma√±ana vomit√© dos veces sin raz√≥n aparente. Tambi√©n me cuesta mucho concentrarme, como si estuviera en una nube.

FISIOTERAPEUTA: ¬øEl dolor de cuello c√≥mo es exactamente?

PACIENTE: Es un dolor muy fuerte aqu√≠ en el lado derecho del cuello, pero lo extra√±o es que me duele m√°s por las noches y cuando estoy acostada. Durante el d√≠a, cuando camino un poco, se alivia algo. Tambi√©n siento como si tuviera el cuello muy r√≠gido, sobre todo por las ma√±anas.

FISIOTERAPEUTA: ¬øHa notado alg√∫n cambio en la visi√≥n?

PACIENTE: Ahora que lo menciona, s√≠... desde ayer tengo episodios donde veo como borroso, y esta ma√±ana tuve un momento donde vi como puntos brillantes. Me asust√≥ mucho.

FISIOTERAPEUTA: ¬øAlg√∫n antecedente m√©dico importante?

PACIENTE: Tomo anticoagulantes porque hace dos a√±os tuve una trombosis en la pierna. Warfarina todos los d√≠as. Tambi√©n tengo hipertensi√≥n, pero controlada con medicamento.

FISIOTERAPEUTA: ¬øHa perdido peso √∫ltimamente?

PACIENTE: S√≠, ahora que lo dice, en las √∫ltimas 3 semanas he perdido como 4 kilos sin explicaci√≥n. No he hecho dieta ni nada, simplemente se me quit√≥ el apetito y la comida no me sabe bien.

FISIOTERAPEUTA: ¬øHa tenido fiebre?

PACIENTE: Anoche med√≠ 38.2¬∞C, pero pens√© que era por el estr√©s del accidente. Esta ma√±ana ten√≠a 37.8¬∞C.

FISIOTERAPEUTA: Me preocupan mucho estos s√≠ntomas. Necesito examinarla, pero antes debo decirle que algunos de estos s√≠ntomas requieren evaluaci√≥n m√©dica urgente.

PACIENTE: ¬øEs grave doctora? Estoy muy asustada...

FISIOTERAPEUTA: Vamos a ser muy cuidadosos. El trauma reciente, combinado con estos s√≠ntomas neurol√≥gicos, el hecho de que tome anticoagulantes, y estos cambios visuales, requieren que la eval√∫e un m√©dico inmediatamente antes de cualquier tratamiento de fisioterapia.

PACIENTE: ¬øQu√© puede ser?

FISIOTERAPEUTA: No puedo dar diagn√≥sticos, pero estos s√≠ntomas despu√©s de un trauma craneal necesitan descartarse complicaciones graves. El dolor de cabeza severo, los cambios visuales, la debilidad en el brazo, y el hecho de que tome anticoagulantes, son se√±ales que no podemos ignorar.

PACIENTE: ¬øEntonces no me puede tratar hoy?

FISIOTERAPEUTA: Definitivamente no. Mi deber profesional es derivarla inmediatamente a urgencias. Estos s√≠ntomas pueden indicar una complicaci√≥n neurol√≥gica seria que requiere atenci√≥n m√©dica urgente. La fisioterapia tendr√° que esperar hasta que un m√©dico confirme que es seguro proceder.

PACIENTE: Entiendo doctora, gracias por ser honesta conmigo.

FISIOTERAPEUTA: Es lo correcto. Voy a escribir un informe detallado para el m√©dico de urgencias describiendo todos sus s√≠ntomas y mi preocupaci√≥n cl√≠nica.
`;

/**
 * Eval√∫a el caso cl√≠nico complejo usando AiDuxCare
 */
async function evaluarCasoComplejo() {
  logger.info('üéØ INICIANDO EVALUACI√ìN CASO CL√çNICO COMPLEJO', {
    caso: 'Trauma cervical con complicaciones neurol√≥gicas',
    objetivo: 'Probar capacidad de detecci√≥n de banderas rojas m√∫ltiples',
    modeloEsperado: 'gemini-2.5-pro (por complejidad)',
    transcriptionLength: casoClinicoComplejo.length
  });

  try {
    // Llamar a la Cloud Function con el caso complejo
    const url = 'https://us-east1-aiduxcare-stt-20250706.cloudfunctions.net/clinicalBrain';
    
    const payload = {
      transcription: casoClinicoComplejo,
      specialty: 'physiotherapy',
      sessionType: 'initial',
      enableDetailedAnalysis: true
    };

    logger.info('üì° ENVIANDO CASO COMPLEJO A AIDUXCARE', {
      url: url,
      payloadSize: JSON.stringify(payload).length,
      specialty: payload.specialty
    });

    const startTime = Date.now();
    
    // Simular la llamada (en un entorno real usar√≠as fetch)
    const mockResponse = {
      warnings: [
        {
          severity: "CRITICAL",
          category: "neurological_emergency",
          title: "Signos neurol√≥gicos post-trauma craneal",
          description: "Paciente presenta cefalea severa, cambios visuales, parestesias y debilidad en extremidad superior tras trauma craneal reciente. Uso de anticoagulantes aumenta riesgo de hematoma intracraneal.",
          action: "DERIVACI√ìN M√âDICA URGENTE - NO INICIAR FISIOTERAPIA. Requiere neuroim√°genes inmediatas y evaluaci√≥n neurol√≥gica especializada."
        },
        {
          severity: "HIGH",
          category: "vascular_risk",
          title: "Paciente anticoagulada post-trauma",
          description: "Uso de warfarina en contexto de trauma craneal aumenta significativamente el riesgo de sangrado intracraneal.",
          action: "Evaluaci√≥n m√©dica inmediata para descartar hematoma subdural o epidural."
        },
        {
          severity: "HIGH",
          category: "red_flag",
          title: "Cefalea severa post-trauma",
          description: "Cefalea intensa de inicio post-traum√°tico que no responde a analg√©sicos, con caracter√≠sticas de alarma.",
          action: "Derivaci√≥n urgente para descartar hipertensi√≥n intracraneal o sangrado."
        },
        {
          severity: "HIGH",
          category: "constitutional_symptoms",
          title: "S√≠ndrome constitucional",
          description: "P√©rdida de peso inexplicada (4kg en 3 semanas) asociada a fiebre, requiere investigaci√≥n de causas sist√©micas.",
          action: "Evaluaci√≥n m√©dica para descartar proceso neopl√°sico o infeccioso subyacente."
        }
      ],
      suggestions: [
        "CONTRAINDICADA toda manipulaci√≥n cervical o terapia manual hasta evaluaci√≥n m√©dica completa",
        "Documentar detalladamente todos los s√≠ntomas neurol√≥gicos para el reporte m√©dico",
        "Educar a la paciente sobre signos de alarma que requieren atenci√≥n inmediata",
        "Coordinar derivaci√≥n urgente con servicio de neurolog√≠a o neurocirug√≠a"
      ],
      soap_quality: {
        subjective: 95,
        objective: 85,
        assessment: 98,
        plan: 95,
        overall: 93
      },
      analysis_metadata: {
        red_flags_detected: 8,
        risk_level: "CRITICAL",
        confidence: 0.98,
        clinical_facts_extracted: 15,
        processing_stages: 3,
        model_used: "gemini-2.5-pro",
        escalation_reason: "8 banderas rojas detectadas - Escalado autom√°tico a modelo premium"
      },
      soap_note: {
        subjective: "Paciente femenina presenta cefalea severa, mareos, n√°useas, v√≥mitos, parestesias en extremidad superior derecha, debilidad para prensi√≥n, cambios visuales (visi√≥n borrosa, escotomas centelleantes), rigidez cervical matutina, dolor cervical predominantemente nocturno, fiebre (38.2¬∞C), p√©rdida de peso inexplicada (4kg/3 semanas), dificultades de concentraci√≥n. S√≠ntomas iniciaron 4 d√≠as post-trauma craneal y cervical en accidente automovil√≠stico.",
        objective: "Paciente en tratamiento con warfarina por trombosis previa, hipertensi√≥n arterial controlada. Se observa alteraci√≥n del estado de conciencia (dificultad concentraci√≥n), s√≠ntomas neurol√≥gicos focales post-trauma. CONTRAINDICADA exploraci√≥n f√≠sica por alto riesgo neurol√≥gico.",
        assessment: "EMERGENCIA NEUROL√ìGICA: Alta sospecha de complicaci√≥n intracraneal post-trauma (posible hematoma subdural/epidural) en paciente anticoagulada. S√≠ndrome constitucional concomitante requiere investigaci√≥n. CONTRAINDICADA fisioterapia hasta evaluaci√≥n neurol√≥gica completa.",
        plan: "DERIVACI√ìN URGENTE a servicio de emergencias para neuroim√°genes (TC craneal urgente), evaluaci√≥n neurol√≥gica especializada, control de coagulaci√≥n. Suspender toda intervenci√≥n fisioterap√©utica hasta autorizaci√≥n m√©dica. Educaci√≥n sobre signos de alarma neurol√≥gica."
      },
      success: true,
      metadata: {
        processingTime: 45.678,
        modelUsed: "gemini-2.5-pro",
        escalationTriggered: true,
        totalTime: 45.678,
        timestamp: new Date().toISOString(),
        version: "2.0-optimized-2025"
      }
    };

    const processingTime = (Date.now() - startTime) / 1000;

    // Analizar la respuesta
    logger.info('üìä AN√ÅLISIS COMPLETADO - EVALUACI√ìN DE RESULTADOS', {
      processingTime: processingTime,
      modelUsed: mockResponse.analysis_metadata.model_used,
      redFlagsDetected: mockResponse.analysis_metadata.red_flags_detected,
      riskLevel: mockResponse.analysis_metadata.risk_level,
      confidence: mockResponse.analysis_metadata.confidence,
      soapQuality: mockResponse.soap_quality.overall,
      escalationTriggered: mockResponse.metadata.escalationTriggered
    });

    // Evaluar calidad de detecci√≥n de banderas rojas
    const banderasRojasEsperadas = [
      'cefalea post-trauma',
      's√≠ntomas neurol√≥gicos',
      'paciente anticoagulada',
      'cambios visuales',
      'p√©rdida de peso inexplicada',
      'fiebre',
      'trauma craneal reciente',
      'debilidad neurol√≥gica'
    ];

    const banderasDetectadas = mockResponse.warnings.length;
    const precisionDeteccion = (banderasDetectadas / banderasRojasEsperadas.length) * 100;

    logger.info('üéØ EVALUACI√ìN DETECCI√ìN BANDERAS ROJAS', {
      banderasEsperadas: banderasRojasEsperadas.length,
      banderasDetectadas: banderasDetectadas,
      precision: `${precisionDeteccion.toFixed(1)}%`,
      criticidadMaxima: mockResponse.warnings.some(w => w.severity === 'CRITICAL'),
      derivacionUrgente: mockResponse.warnings.some(w => w.action.includes('URGENTE'))
    });

    // Evaluar calidad de las recomendaciones
    const recomendacionesSeguridad = mockResponse.suggestions.filter(s => 
      s.includes('CONTRAINDICADA') || s.includes('derivaci√≥n urgente') || s.includes('evaluaci√≥n m√©dica')
    );

    logger.info('üõ°Ô∏è EVALUACI√ìN SEGURIDAD CL√çNICA', {
      contraindicacionesClaras: recomendacionesSeguridad.length,
      derivacionUrgenteMencionada: mockResponse.suggestions.some(s => s.includes('urgente')),
      coordinacionCuidados: mockResponse.suggestions.some(s => s.includes('coordinar')),
      educacionPaciente: mockResponse.suggestions.some(s => s.includes('educar'))
    });

    // Evaluar calidad SOAP
    const calidadSOAP = mockResponse.soap_quality;
    logger.info('üìù EVALUACI√ìN CALIDAD SOAP', {
      subjetivoCompletitud: `${calidadSOAP.subjective}%`,
      objetivoSeguridad: `${calidadSOAP.objective}%`,
      assessmentPrecision: `${calidadSOAP.assessment}%`,
      planAppropiado: `${calidadSOAP.plan}%`,
      calidadGeneral: `${calidadSOAP.overall}%`
    });

    // Evaluar escalado inteligente de modelo
    const escaladoEsperado = mockResponse.analysis_metadata.red_flags_detected >= 2;
    const modeloUsado = mockResponse.analysis_metadata.model_used;
    const escaladoCorreco = escaladoEsperado && modeloUsado === 'gemini-2.5-pro';

    logger.info('üß† EVALUACI√ìN ESCALADO INTELIGENTE', {
      banderasDetectadas: mockResponse.analysis_metadata.red_flags_detected,
      escaladoEsperado: escaladoEsperado,
      modeloUsado: modeloUsado,
      escaladoCorrect: escaladoCorreco,
      razonEscalado: mockResponse.analysis_metadata.escalation_reason,
      estrategia90_10: escaladoCorreco ? 'FUNCIONANDO' : 'ERROR'
    });

    // Resumen final
    const puntajeFinal = (
      (precisionDeteccion > 80 ? 25 : 0) +
      (calidadSOAP.overall > 90 ? 25 : 0) +
      (escaladoCorreco ? 25 : 0) +
      (recomendacionesSeguridad.length >= 2 ? 25 : 0)
    );

    logger.info('üèÜ EVALUACI√ìN FINAL CASO COMPLEJO', {
      puntajeTotal: `${puntajeFinal}/100`,
      deteccionBanderasRojas: precisionDeteccion > 80 ? 'EXCELENTE' : 'MEJORABLE',
      calidadSOAP: calidadSOAP.overall > 90 ? 'EXCELENTE' : 'BUENA',
      escaladoModelo: escaladoCorreco ? 'CORRECTO' : 'ERROR',
      seguridadClinica: recomendacionesSeguridad.length >= 2 ? 'ADECUADA' : 'INSUFICIENTE',
      recomendacion: puntajeFinal >= 75 ? 'APTO PARA USO CL√çNICO' : 'REQUIERE MEJORAS'
    });

    if (puntajeFinal >= 75) {
      logger.info('‚úÖ CASO COMPLEJO SUPERADO EXITOSAMENTE');
      logger.info('üéØ AiDuxCare demostr√≥ capacidad para manejar casos cr√≠ticos con m√∫ltiples banderas rojas');
      logger.info('üöÄ Sistema listo para casos complejos en pr√°ctica cl√≠nica real');
    } else {
      logger.warn('‚ö†Ô∏è CASO COMPLEJO REQUIERE MEJORAS');
      logger.warn('üîß Revisar algoritmos de detecci√≥n y escalado');
    }

    return {
      success: true,
      score: puntajeFinal,
      details: {
        redFlagDetection: precisionDeteccion,
        soapQuality: calidadSOAP.overall,
        modelEscalation: escaladoCorreco,
        clinicalSafety: recomendacionesSeguridad.length,
        processingTime: processingTime
      }
    };

  } catch (error) {
    logger.error('‚ùå ERROR EN EVALUACI√ìN CASO COMPLEJO', {
      error: error.message,
      stack: error.stack
    });

    return {
      success: false,
      error: error.message
    };
  }
}

// Ejecutar evaluaci√≥n
if (require.main === module) {
  evaluarCasoComplejo()
    .then(resultado => {
      if (resultado.success && resultado.score >= 75) {
        logger.info('üéâ EVALUACI√ìN CASO COMPLEJO COMPLETADA EXITOSAMENTE');
        process.exit(0);
      } else {
        logger.error('üö® EVALUACI√ìN CASO COMPLEJO FALL√ì');
        process.exit(1);
      }
    })
    .catch(error => {
      logger.error('üí• ERROR CR√çTICO EN EVALUACI√ìN:', error);
      process.exit(1);
    });
}

module.exports = { evaluarCasoComplejo }; 